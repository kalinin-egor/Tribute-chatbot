# Архитектура Tribute Chatbot

## Обзор

Tribute Chatbot теперь использует модульную архитектуру для лучшей масштабируемости и поддержки кода.

## Структура проекта

```
tribute-chatbot/
├── main.go                          # Точка входа в приложение
├── internal/                        # Внутренние пакеты
│   ├── bot/                         # Основная логика бота
│   │   └── bot.go                   # Структура и инициализация бота
│   ├── config/                      # Конфигурация
│   │   └── config.go                # Загрузка конфигурации
│   ├── handlers/                    # Обработчики команд и событий
│   │   ├── common/                  # Общие команды
│   │   │   └── handler.go           # /start, /help, /echo, текстовые сообщения
│   │   ├── verification/            # Верификация пользователей
│   │   │   └── handler.go           # /verificate, фотографии, callback
│   │   └── channel/                 # Работа с каналами
│   │       └── handler.go           # Добавление бота в каналы
│   ├── models/                      # Модели данных
│   │   └── verification.go          # Структуры для верификации
│   ├── services/                    # Бизнес-логика
│   │   ├── verification_service.go  # Управление состоянием верификации
│   │   └── api_service.go           # Работа с API бэкенда
│   ├── logger/                      # Логирование
│   │   └── logger.go                # Интерфейс логгера
│   └── middleware/                  # Промежуточное ПО (для будущего использования)
├── logs/                            # Логи приложения
├── .env                             # Переменные окружения
├── Dockerfile                       # Docker образ
├── docker-compose.yml               # Docker Compose
└── README.md                        # Документация
```

## Компоненты архитектуры

### 1. Models (Модели данных)

**`internal/models/verification.go`**
- `VerificationState` - состояние верификации пользователя
- `VerificationData` - данные для отправки в админский чат
- `VerificationCallbackData` - данные callback кнопки
- Константы этапов верификации

### 2. Services (Сервисы)

**`internal/services/verification_service.go`**
- Управление состоянием верификации пользователей
- Потокобезопасное хранение состояний
- Методы для обновления этапов верификации

**`internal/services/api_service.go`**
- Работа с API бэкенда
- Обновление статуса верификации
- Добавление бота в каналы

### 3. Handlers (Обработчики)

**`internal/handlers/common/handler.go`**
- `/start` - приветствие и кнопка WebApp
- `/help` - справка по командам
- `/echo` - повторение текста
- Обработка текстовых сообщений
- Обработка WebApp данных

**`internal/handlers/verification/handler.go`**
- `/verificate` - начало процесса верификации
- Обработка фотографий (селфи и паспорт)
- Отправка в админский чат с inline кнопками
- Обработка callback кнопок
- Удаление сообщений после обработки

**`internal/handlers/channel/handler.go`**
- Обработка событий добавления бота в каналы
- Отправка данных в API при назначении админом

### 4. Bot (Основная логика)

**`internal/bot/bot.go`**
- Инициализация всех компонентов
- Настройка обработчиков
- Управление жизненным циклом бота

## Принципы архитектуры

### 1. Разделение ответственности
- Каждый пакет отвечает за свою область
- Сервисы содержат бизнес-логику
- Обработчики отвечают только за взаимодействие с Telegram API

### 2. Dependency Injection
- Сервисы передаются в обработчики через конструкторы
- Легкое тестирование и замена компонентов

### 3. Модульность
- Каждый функционал изолирован в своем пакете
- Легкое добавление новых команд и обработчиков

### 4. Потокобезопасность
- Сервисы используют мьютексы для защиты данных
- Безопасная работа с состоянием верификации

## Добавление новых функций

### 1. Новая команда
1. Создать обработчик в `internal/handlers/`
2. Добавить метод в соответствующий handler
3. Зарегистрировать в `internal/bot/bot.go`

### 2. Новый сервис
1. Создать файл в `internal/services/`
2. Реализовать интерфейс или структуру
3. Внедрить через dependency injection

### 3. Новая модель
1. Создать файл в `internal/models/`
2. Определить структуры и константы
3. Использовать в сервисах и обработчиках

## Преимущества новой архитектуры

1. **Масштабируемость** - легко добавлять новые функции
2. **Тестируемость** - каждый компонент можно тестировать отдельно
3. **Поддерживаемость** - код организован логически
4. **Переиспользование** - сервисы можно использовать в разных обработчиках
5. **Читаемость** - четкая структура и разделение ответственности

## Конфигурация

Все настройки хранятся в `.env` файле:
```
TELEGRAM_BOT_TOKEN=your_bot_token
TELEGRAM_ADMIN_CHAT_ID=your_admin_chat_id
LOG_LEVEL=info
API_BASE_URL=https://your-api-url.com
```

## Запуск

```bash
# Локально
go run main.go

# В Docker
docker-compose up --build
``` 